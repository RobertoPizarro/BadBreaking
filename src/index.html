<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Farmacia - Sistema de Gesti√≥n</title>
    <style>
        body { font-family: Arial; max-width: 1200px; margin: 50px auto; padding: 20px; }
        .section { margin: 30px 0; padding: 20px; border: 1px solid #ddd; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #4CAF50; color: white; }
    </style>
</head>
<body>
    <h1>üè• Sistema de Farmacia Oracle</h1>

    <!-- SECCI√ìN REPORTES -->
    <div class="section">
        <h2>üìä Reportes Din√°micos (PL/SQL)</h2>
        <button onclick="cargarReporte('top-vendidos')">Top 5 M√°s Vendidos</button>
        <button onclick="cargarReporte('proximos-vencer')">Pr√≥ximos a Vencer</button>
        <button onclick="cargarReporte('sin-stock')">Sin Stock</button>
        <button onclick="cargarReporte('ingresos-mensuales')">Ingresos por Mes</button>
        <div id="resultados"></div>
    </div>

    <!-- SECCI√ìN VENTAS -->
    <div class="section">
        <h2>üí∞ Registrar Venta (Activa Trigger de Stock)</h2>
        <button onclick="simularVenta()">Simular Venta de Prueba</button>
        <div id="ventaResultado"></div>
    </div>

    <script>
        const API_URL = 'http://localhost:8080/api';

        async function cargarReporte(tipo) {
            const div = document.getElementById('resultados');
            div.innerHTML = '<p>‚è≥ Cargando desde Oracle...</p>';

            try {
                const res = await fetch(`${API_URL}/reportes/${tipo}`);
                const data = await res.json();

                if (data.estado === 'exito') {
                    let html = `<h3>Resultados: ${data.total || data.datos.length} registros</h3>`;
                    html += '<table><thead><tr>';

                    // Encabezados
                    const keys = Object.keys(data.datos[0] || {});
                    keys.forEach(k => html += `<th>${k.toUpperCase()}</th>`);
                    html += '</tr></thead><tbody>';

                    // Filas
                    data.datos.forEach(row => {
                        html += '<tr>';
                        keys.forEach(k => html += `<td>${row[k]}</td>`);
                        html += '</tr>';
                    });
                    html += '</tbody></table>';
                    div.innerHTML = html;
                } else {
                    div.innerHTML = `<p style="color:red">‚ùå ${data.mensaje}</p>`;
                }
            } catch (e) {
                div.innerHTML = `<p style="color:red">‚ùå Error: ${e.message}</p>`;
            }
        }

        async function simularVenta() {
            const div = document.getElementById('ventaResultado');
            div.innerHTML = '<p>‚è≥ Procesando venta (trigger reducir√° stock)...</p>';

            const venta = {
                id_cliente: 1,
                id_empleado: 1,
                total_venta: 5.00,
                detalles: [
                    { id_medicamento: 1, cantidad: 2, precio_unitario_venta: 1.00 },
                    { id_medicamento: 3, cantidad: 2, precio_unitario_venta: 1.50 }
                ]
            };

            try {
                const res = await fetch(`${API_URL}/ventas`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(venta)
                });
                const data = await res.json();

                if (data.estado === 'exito') {
                    div.innerHTML = `<p style="color:green">‚úÖ Venta ID ${data.id_venta} registrada. El trigger actualiz√≥ el stock autom√°ticamente.</p>`;
                } else {
                    div.innerHTML = `<p style="color:red">‚ùå ${data.mensaje}</p>`;
                }
            } catch (e) {
                div.innerHTML = `<p style="color:red">‚ùå Error: ${e.message}</p>`;
            }
        }
    </script>
</body>
</html>