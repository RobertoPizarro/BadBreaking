ALTER SESSION SET "_ORACLE_SCRIPT" = TRUE;

-- Creación de usuario
CREATE USER walterw IDENTIFIED BY 1234
DEFAULT TABLESPACE users
TEMPORARY TABLESPACE temp
QUOTA UNLIMITED ON users;

GRANT CONNECT, RESOURCE, CREATE VIEW, CREATE TRIGGER, CREATE PROCEDURE TO walterw;

SET SERVEROUTPUT ON;

-- ==========================================================
-- 1. LIMPIEZA
-- ==========================================================
BEGIN
    FOR t IN (SELECT table_name FROM user_tables) LOOP
        EXECUTE IMMEDIATE 'DROP TABLE ' || t.table_name || ' CASCADE CONSTRAINTS PURGE';
    END LOOP;
    FOR s IN (SELECT sequence_name FROM user_sequences WHERE sequence_name NOT LIKE 'ISEQ$$%') LOOP
        EXECUTE IMMEDIATE 'DROP SEQUENCE ' || s.sequence_name;
    END LOOP;
END;
/


-- ==========================================================
-- 2. CREACIÓN DE TABLAS
-- ==========================================================

-- 2.1. Usuarios (Tabla Padre)
CREATE TABLE Usuarios (
    dni               VARCHAR2(15) NOT NULL,
    nombre            VARCHAR2(100) NOT NULL,
    apellido_paterno  VARCHAR2(100) NOT NULL,
    apellido_materno  VARCHAR2(100),
    CONSTRAINT pk_usuarios PRIMARY KEY (dni)
);

-- 2.2. Clientes y Empleados (Herencia)
CREATE TABLE Clientes (
    dni VARCHAR2(15) NOT NULL,
    CONSTRAINT pk_clientes PRIMARY KEY (dni),
    CONSTRAINT fk_clientes_usuarios FOREIGN KEY (dni) REFERENCES Usuarios(dni) ON DELETE CASCADE
);

CREATE TABLE Empleados (
    dni               VARCHAR2(15) NOT NULL,
    puesto            VARCHAR2(50) NOT NULL,
    fecha_contratacion DATE DEFAULT SYSDATE,
    usuario_sistema   VARCHAR2(50) UNIQUE NOT NULL,
    CONSTRAINT pk_empleados PRIMARY KEY (dni),
    CONSTRAINT fk_empleados_usuarios FOREIGN KEY (dni) REFERENCES Usuarios(dni) ON DELETE CASCADE
);

-- 2.3. Inventario
CREATE TABLE Proveedores (
    id_proveedor      NUMBER(10) GENERATED BY DEFAULT AS IDENTITY NOT NULL,
    nombre            VARCHAR2(100) NOT NULL,
    contacto_telefono VARCHAR2(15),
    email             VARCHAR2(100),
    direccion         VARCHAR2(255),
    estado            VARCHAR2(10) DEFAULT 'Activo' NOT NULL,
    CONSTRAINT pk_proveedores PRIMARY KEY (id_proveedor)
);

CREATE TABLE Categorias (
    id_categoria      NUMBER(10) GENERATED BY DEFAULT AS IDENTITY NOT NULL,
    nombre            VARCHAR2(100) NOT NULL,
    descripcion       VARCHAR2(255),
    CONSTRAINT pk_categorias PRIMARY KEY (id_categoria)
);

CREATE TABLE Medicamentos (
    id_medicamento    NUMBER(10) GENERATED BY DEFAULT AS IDENTITY NOT NULL,
    nombre            VARCHAR2(100) NOT NULL,
    id_categoria      NUMBER(10) NOT NULL,
    id_proveedor      NUMBER(10),
    stock             NUMBER(6) DEFAULT 0 NOT NULL,
    precio_compra     NUMBER(10, 2) NOT NULL,
    precio_venta      NUMBER(10, 2) NOT NULL,
    fecha_vencimiento DATE NOT NULL,
    lote              VARCHAR2(50) NOT NULL,
    ubicacion         VARCHAR2(50), -- Es opcional (NULL permitido)
    descripcion       VARCHAR2(500), -- Es opcional (NULL permitido)
    estado            VARCHAR2(10) DEFAULT 'Activo' NOT NULL,
    CONSTRAINT pk_medicamentos PRIMARY KEY (id_medicamento),
    CONSTRAINT fk_medicamentos_cat FOREIGN KEY (id_categoria) REFERENCES Categorias(id_categoria),
    CONSTRAINT fk_medicamentos_prov FOREIGN KEY (id_proveedor) REFERENCES Proveedores(id_proveedor),
    CONSTRAINT chk_medicamentos_stock CHECK (stock >= 0)
);

-- 2.4. Ventas y Auditoría
CREATE TABLE Ventas (
    id_venta          NUMBER(10) GENERATED BY DEFAULT AS IDENTITY NOT NULL,
    dni_cliente       VARCHAR2(15) NOT NULL,
    dni_empleado      VARCHAR2(15) NOT NULL,
    fecha_venta       TIMESTAMP DEFAULT SYSTIMESTAMP NOT NULL,
    total_venta       NUMBER(10, 2) DEFAULT 0,
    CONSTRAINT pk_ventas PRIMARY KEY (id_venta),
    CONSTRAINT fk_ventas_cli FOREIGN KEY (dni_cliente) REFERENCES Clientes(dni),
    CONSTRAINT fk_ventas_emp FOREIGN KEY (dni_empleado) REFERENCES Empleados(dni)
);

CREATE TABLE Venta_Detalle (
    id_detalle        NUMBER(10) GENERATED BY DEFAULT AS IDENTITY NOT NULL,
    id_venta          NUMBER(10) NOT NULL,
    id_medicamento    NUMBER(10) NOT NULL,
    cantidad          NUMBER(4) NOT NULL,
    precio_unitario_venta NUMBER(10, 2) NOT NULL,
    subtotal AS (cantidad * precio_unitario_venta),
    CONSTRAINT pk_venta_detalle PRIMARY KEY (id_detalle),
    CONSTRAINT fk_detalle_vta FOREIGN KEY (id_venta) REFERENCES Ventas(id_venta) ON DELETE CASCADE,
    CONSTRAINT fk_detalle_med FOREIGN KEY (id_medicamento) REFERENCES Medicamentos(id_medicamento)
);

CREATE TABLE Auditoria_Medicamentos (
    id_auditoria      NUMBER(10) GENERATED BY DEFAULT AS IDENTITY NOT NULL,
    id_medicamento_afectado NUMBER(10),
    nombre_medicamento  VARCHAR2(100),
    accion_realizada    VARCHAR2(2000),
    usuario_db          VARCHAR2(50),
    fecha_accion        TIMESTAMP DEFAULT SYSTIMESTAMP,
    CONSTRAINT pk_auditoria PRIMARY KEY (id_auditoria)
);

-- ==========================================================
-- 3. TRIGGERS
-- ==========================================================

-- 3.1.

CREATE OR REPLACE TRIGGER trg_control_stock_inteligente
AFTER INSERT ON Venta_Detalle FOR EACH ROW
DECLARE
    v_stock_actual NUMBER;
    v_nombre_med VARCHAR2(100);
    v_precio_compra NUMBER(10,2);
    v_precio_venta NUMBER(10,2);
    v_ganancia NUMBER(10,2);
    v_margen_porcentaje NUMBER(5,2);
BEGIN
    -- Obtener información del medicamento
    SELECT stock, nombre, precio_compra, precio_venta
    INTO v_stock_actual, v_nombre_med, v_precio_compra, v_precio_venta
    FROM Medicamentos
    WHERE id_medicamento = :NEW.id_medicamento;
    
    -- Validar stock suficiente
    IF v_stock_actual < :NEW.cantidad THEN
        RAISE_APPLICATION_ERROR(-20003, 
            'Stock insuficiente para ' || v_nombre_med || 
            '. Disponible: ' || v_stock_actual || ', Solicitado: ' || :NEW.cantidad);
    END IF;
    
    -- Calcular métricas de rentabilidad y auditar si es necesario
    v_margen_porcentaje := ROUND(((v_precio_venta - v_precio_compra) / v_precio_venta) * 100, 2);
    IF v_margen_porcentaje < 20 THEN
        INSERT INTO Auditoria_Medicamentos (
            id_medicamento_afectado, nombre_medicamento, accion_realizada, usuario_db, fecha_accion
        ) VALUES (
            :NEW.id_medicamento, v_nombre_med, 'VENTA_MARGEN_BAJO: ' || v_margen_porcentaje || '% | Cant: ' || :NEW.cantidad, USER, SYSTIMESTAMP
        );
    END IF;
    
    -- Reducir stock. El estado ('Agotado' o 'Activo') será actualizado por el trigger trg_validar_medicamento_completo
    UPDATE Medicamentos
    SET stock = stock - :NEW.cantidad
    WHERE id_medicamento = :NEW.id_medicamento;
    
    -- Si el stock resultante es crítico (<=5), registrar alerta de auditoría
    IF (v_stock_actual - :NEW.cantidad) <= 5 AND (v_stock_actual - :NEW.cantidad) > 0 THEN
        INSERT INTO Auditoria_Medicamentos (
            id_medicamento_afectado, nombre_medicamento, accion_realizada, usuario_db, fecha_accion
        ) VALUES (
            :NEW.id_medicamento, v_nombre_med, 'ALERTA_STOCK_CRITICO: Quedan ' || (v_stock_actual - :NEW.cantidad) || ' unidades', USER, SYSTIMESTAMP
        );
    END IF;
    
EXCEPTION
    WHEN NO_DATA_FOUND THEN
        RAISE_APPLICATION_ERROR(-20002, 'Medicamento no encontrado ID: ' || :NEW.id_medicamento);
    WHEN OTHERS THEN
        RAISE_APPLICATION_ERROR(-20099, 'Error en control de stock: ' || SQLERRM);
END;
/

-- 3.2.

CREATE OR REPLACE TRIGGER trg_validar_medicamento_completo
BEFORE INSERT OR UPDATE ON Medicamentos FOR EACH ROW
DECLARE
    v_dias_para_vencer NUMBER;
    v_count_lote NUMBER;
BEGIN
    -- No permitir cambios a registros lógicamente eliminados, a menos que se esté reactivando
    IF :OLD.estado = 'Inactivo' AND :NEW.estado = 'Inactivo' THEN
        RAISE_APPLICATION_ERROR(-20010, 'No se pueden modificar medicamentos marcados como Inactivos.');
    END IF;
    
    -- 1. Validar fecha de vencimiento (no puede ser pasada)
    IF :NEW.fecha_vencimiento < TRUNC(SYSDATE) THEN
        RAISE_APPLICATION_ERROR(-20001, 
            'No se puede registrar medicamento vencido. Fecha: ' || 
            TO_CHAR(:NEW.fecha_vencimiento, 'DD/MM/YYYY'));
    END IF;
    
    -- 2. Validar si está próximo a vencer (menos de 60 días)
    v_dias_para_vencer := :NEW.fecha_vencimiento - TRUNC(SYSDATE);
    IF v_dias_para_vencer <= 60 AND v_dias_para_vencer > 0 THEN
        DBMS_OUTPUT.PUT_LINE('⚠️  ADVERTENCIA: ' || :NEW.nombre || 
                            ' vence en ' || v_dias_para_vencer || ' días');
    END IF;
    
    -- 3. Validar precios lógicos
    IF :NEW.precio_venta <= :NEW.precio_compra THEN
        RAISE_APPLICATION_ERROR(-20004, 
            'Precio de venta debe ser mayor al precio de compra. ' ||
            'Compra: S/.' || :NEW.precio_compra || ', Venta: S/.' || :NEW.precio_venta);
    END IF;
    
    -- 4. Validar margen mínimo del 10%
    IF ((:NEW.precio_venta - :NEW.precio_compra) / :NEW.precio_venta) < 0.10 THEN
        RAISE_APPLICATION_ERROR(-20005, 
            'Margen de ganancia muy bajo (menor al 10%). Ajuste los precios.');
    END IF;
    
    -- 5. Validar duplicado de lote
    IF INSERTING THEN
        SELECT COUNT(*) INTO v_count_lote
        FROM Medicamentos
        WHERE lote = :NEW.lote 
          AND nombre = :NEW.nombre
          AND id_medicamento != NVL(:NEW.id_medicamento, -1);
        
        IF v_count_lote > 0 THEN
            RAISE_APPLICATION_ERROR(-20006, 
                'Ya existe un medicamento con el lote ' || :NEW.lote || 
                '. Use un lote diferente o verifique si es reposición.');
        END IF;
    END IF;
    
    -- 6. GESTIÓN DE ESTADO CENTRALIZADA
    -- Solo se gestiona el estado si no está siendo marcado como 'Inactivo' manualmente.
    -- El estado 'Inactivo' tiene prioridad para borrados lógicos.
    IF :NEW.estado != 'Inactivo' THEN
        IF :NEW.stock <= 0 THEN
            :NEW.estado := 'Agotado';
        ELSE
            -- Si el stock es positivo, siempre debe estar 'Activo'.
            -- Esto también resuelve el caso de reponer stock a un producto 'Agotado'.
            :NEW.estado := 'Activo';
        END IF;
    END IF;
    
END;
/

-- 3.3. 

CREATE OR REPLACE TRIGGER trg_auditoria_avanzada_medicamentos
AFTER INSERT OR UPDATE OR DELETE ON Medicamentos FOR EACH ROW
DECLARE
    v_accion VARCHAR2(500);
    v_detalles VARCHAR2(2000) := ''; -- Aumentado para más detalles
BEGIN
    IF INSERTING THEN
        v_accion := 'REGISTRO_NUEVO';
        v_detalles := 'Stock inicial: ' || :NEW.stock || 
                     ' | Precio Venta: S/.' || :NEW.precio_venta ||
                     ' | Vence: ' || TO_CHAR(:NEW.fecha_vencimiento, 'DD/MM/YYYY') ||
                     ' | Lote: ' || :NEW.lote;
        
    ELSIF DELETING THEN
        v_accion := 'ELIMINACION_FISICA';
        v_detalles := 'Se eliminó permanentemente el registro. ' ||
                     'Último stock: ' || :OLD.stock ||
                     ' | Último estado: ' || :OLD.estado ||
                     ' | Lote: ' || :OLD.lote ||
                     ' | Valor inventario perdido: S/.' || ROUND(:OLD.stock * :OLD.precio_compra, 2);

    ELSIF UPDATING THEN
        v_accion := 'ACTUALIZACION';
        
        -- Construir una cadena con todos los cambios detectados
        IF :OLD.nombre != :NEW.nombre THEN
            v_detalles := v_detalles || 'Nombre: "' || :OLD.nombre || '" -> "' || :NEW.nombre || '". ';
        END IF;
        IF :OLD.stock != :NEW.stock THEN
            v_detalles := v_detalles || 'Stock: ' || :OLD.stock || ' -> ' || :NEW.stock || '. ';
        END IF;
        IF :OLD.precio_compra != :NEW.precio_compra THEN
            v_detalles := v_detalles || 'P. Compra: ' || :OLD.precio_compra || ' -> ' || :NEW.precio_compra || '. ';
        END IF;
        IF :OLD.precio_venta != :NEW.precio_venta THEN
            v_detalles := v_detalles || 'P. Venta: ' || :OLD.precio_venta || ' -> ' || :NEW.precio_venta || '. ';
        END IF;
        IF :OLD.estado != :NEW.estado THEN
            v_detalles := v_detalles || 'Estado: "' || :OLD.estado || '" -> "' || :NEW.estado || '". ';
        END IF;
        IF :OLD.lote != :NEW.lote THEN
            v_detalles := v_detalles || 'Lote: "' || :OLD.lote || '" -> "' || :NEW.lote || '". ';
        END IF;
        
        -- Si no se detectó ningún cambio auditable, no se inserta nada
        IF LENGTH(v_detalles) = 0 THEN
            RETURN; -- Salir del trigger si no hay cambios relevantes
        END IF;
        
        -- Si el único cambio es para marcar como inactivo, usar un mensaje más específico
        IF :OLD.estado != 'Inactivo' AND :NEW.estado = 'Inactivo' AND v_detalles = 'Estado: "' || :OLD.estado || '" -> "' || :NEW.estado || '". ' THEN
            v_accion := 'ELIMINACION_LOGICA';
        END IF;
        
    END IF;

    -- Insertar el registro de auditoría
    INSERT INTO Auditoria_Medicamentos (
        id_medicamento_afectado,
        nombre_medicamento,
        accion_realizada,
        usuario_db,
        fecha_accion
    ) VALUES (
        NVL(:NEW.id_medicamento, :OLD.id_medicamento), -- Usar NEW para INSERT/UPDATE, OLD para DELETE
        NVL(:NEW.nombre, :OLD.nombre),
        v_accion || ' - ' || v_detalles,
        USER,
        SYSTIMESTAMP
    );
    
EXCEPTION
    WHEN OTHERS THEN
        -- No interfiere con la operación principal si la auditoría falla
        DBMS_OUTPUT.PUT_LINE('Error en auditoría (no crítico): ' || SQLERRM);
END;
/


-- ==========================================================
-- 4. DATOS INICIALES
-- ==========================================================
-- Categorías y Proveedores
INSERT INTO Categorias (nombre, descripcion) VALUES ('Analgesicos', 'Alivio dolor');
INSERT INTO Categorias (nombre, descripcion) VALUES ('Antibioticos', 'Infecciones');
INSERT INTO Categorias (nombre, descripcion) VALUES ('Vitaminas', 'Suplementos');
INSERT INTO Categorias (nombre, descripcion) VALUES ('Antiinflamatorios', 'Reducción de inflamación');
INSERT INTO Categorias (nombre, descripcion) VALUES ('Antihistamínicos', 'Tratamiento de alergias');
INSERT INTO Categorias (nombre, descripcion) VALUES ('Antihipertensivos', 'Control de presión arterial');
INSERT INTO Categorias (nombre, descripcion) VALUES ('Antidiabéticos', 'Control de glucosa');
INSERT INTO Categorias (nombre, descripcion) VALUES ('Dermatológicos', 'Cuidado de la piel');
INSERT INTO Categorias (nombre, descripcion) VALUES ('Gastrointestinales', 'Sistema digestivo');
INSERT INTO Categorias (nombre, descripcion) VALUES ('Respiratorios', 'Sistema respiratorio');
INSERT INTO Categorias (nombre, descripcion) VALUES ('Antiácidos', 'Acidez estomacal');
INSERT INTO Proveedores (nombre, contacto_telefono, email, direccion) VALUES ('PharmaCorp', '987654321', 'ventas@pharma.com', 'Av Principal');
INSERT INTO Proveedores (nombre, contacto_telefono, email, direccion) VALUES ('Medilab', '999888777', 'pedidos@medilab.com', 'Jr Secundario');
INSERT INTO Proveedores (nombre, contacto_telefono, email, direccion) VALUES ('BioFarma SAC', '998877665', 'info@biofarma.pe', 'Av. Arequipa 2450');
INSERT INTO Proveedores (nombre, contacto_telefono, email, direccion) VALUES ('Droguería Lima', '997766554', 'ventas@droguerialima.com', 'Jr. Cusco 890');
INSERT INTO Proveedores (nombre, contacto_telefono, email, direccion) VALUES ('MedSupply Peru', '996655443', 'pedidos@medsupply.pe', 'Av. Javier Prado 1234');
INSERT INTO Proveedores (nombre, contacto_telefono, email, direccion) VALUES ('FarmaDistribuidora', '995544332', 'contacto@farmadist.com', 'Calle Los Olivos 567');
INSERT INTO Proveedores (nombre, contacto_telefono, email, direccion) VALUES ('GlobalMed Imports', '994433221', 'importaciones@globalmed.pe', 'Av. Colonial 3400');


-- Usuarios (Clientes y Empleados)
INSERT INTO Usuarios (dni, nombre, apellido_paterno, apellido_materno) VALUES ('12345678', 'Walter', 'White', 'Hartwell');
INSERT INTO Usuarios (dni, nombre, apellido_paterno, apellido_materno) VALUES ('87654322', 'Jesse', 'Pinkman', NULL);
INSERT INTO Usuarios (dni, nombre, apellido_paterno, apellido_materno) VALUES ('45678901', 'Ana', 'Gomez', NULL);
INSERT INTO Usuarios (dni, nombre, apellido_paterno, apellido_materno) VALUES ('87654321', 'Luis', 'Torres', NULL);
INSERT INTO Usuarios (dni, nombre, apellido_paterno, apellido_materno) VALUES ('23456789', 'María', 'López', 'García');
INSERT INTO Usuarios (dni, nombre, apellido_paterno, apellido_materno) VALUES ('34567890', 'Carlos', 'Ramírez', 'Flores');
INSERT INTO Usuarios (dni, nombre, apellido_paterno, apellido_materno) VALUES ('56789012', 'Rosa', 'Mendoza', 'Silva');
INSERT INTO Usuarios (dni, nombre, apellido_paterno, apellido_materno) VALUES ('67890123', 'Pedro', 'Castro', 'Vega');
INSERT INTO Usuarios (dni, nombre, apellido_paterno, apellido_materno) VALUES ('78901234', 'Julia', 'Herrera', 'Rojas');
INSERT INTO Usuarios (dni, nombre, apellido_paterno, apellido_materno) VALUES ('89012345', 'Diego', 'Morales', 'Campos');
INSERT INTO Usuarios (dni, nombre, apellido_paterno, apellido_materno) VALUES ('90123456', 'Carmen', 'Quispe', 'Huamán');
INSERT INTO Usuarios (dni, nombre, apellido_paterno, apellido_materno) VALUES ('01234567', 'Roberto', 'Sánchez', 'Díaz');
INSERT INTO Usuarios (dni, nombre, apellido_paterno, apellido_materno) VALUES ('11223344', 'Lucía', 'Vargas', 'Torres');
INSERT INTO Usuarios (dni, nombre, apellido_paterno, apellido_materno) VALUES ('22334455', 'Fernando', 'Rojas', 'Pérez');
INSERT INTO Usuarios (dni, nombre, apellido_paterno, apellido_materno) VALUES ('33445566', 'Patricia', 'Gonzales', 'Medina');
INSERT INTO Usuarios (dni, nombre, apellido_paterno, apellido_materno) VALUES ('44556677', 'Miguel', 'Fernández', 'Cruz');
INSERT INTO Usuarios (dni, nombre, apellido_paterno, apellido_materno) VALUES ('55667788', 'Andrea', 'Paredes', 'Luna');
INSERT INTO Usuarios (dni, nombre, apellido_paterno, apellido_materno) VALUES ('66778899', 'Jorge', 'Valdez', 'Ríos');
INSERT INTO Usuarios (dni, nombre, apellido_paterno, apellido_materno) VALUES ('77889900', 'Elena', 'Cárdenas', 'Salazar');

-- Roles
INSERT INTO Empleados (dni, puesto, usuario_sistema) VALUES ('12345678', 'Quimico', 'walterw');
INSERT INTO Empleados (dni, puesto, usuario_sistema) VALUES ('87654322', 'Tecnico', 'jpinkman');
INSERT INTO Empleados (dni, puesto, usuario_sistema) VALUES ('23456789', 'Farmacéutica', 'mlopez');
INSERT INTO Empleados (dni, puesto, usuario_sistema) VALUES ('34567890', 'Asistente', 'cramirez');
INSERT INTO Empleados (dni, puesto, usuario_sistema) VALUES ('56789012', 'Cajera', 'rmendoza');
INSERT INTO Empleados (dni, puesto, usuario_sistema) VALUES ('67890123', 'Supervisor', 'pcastro');
INSERT INTO Clientes (dni) VALUES ('45678901');
INSERT INTO Clientes (dni) VALUES ('87654321');
INSERT INTO Clientes (dni) VALUES ('78901234');
INSERT INTO Clientes (dni) VALUES ('89012345');
INSERT INTO Clientes (dni) VALUES ('90123456');
INSERT INTO Clientes (dni) VALUES ('01234567');
INSERT INTO Clientes (dni) VALUES ('11223344');
INSERT INTO Clientes (dni) VALUES ('22334455');
INSERT INTO Clientes (dni) VALUES ('33445566');
INSERT INTO Clientes (dni) VALUES ('44556677');
INSERT INTO Clientes (dni) VALUES ('55667788');
INSERT INTO Clientes (dni) VALUES ('66778899');
INSERT INTO Clientes (dni) VALUES ('77889900');

-- Medicamentos
INSERT INTO Medicamentos (nombre, id_categoria, id_proveedor, stock, precio_compra, precio_venta, fecha_vencimiento, lote, ubicacion, estado) VALUES ('Paracetamol 500mg', 1, 1, 100, 0.50, 1.00, TO_DATE('2026-12-31', 'YYYY-MM-DD'), 'LOTE-P001', 'A-01', 'Activo');
INSERT INTO Medicamentos (nombre, id_categoria, id_proveedor, stock, precio_compra, precio_venta, fecha_vencimiento, lote, ubicacion, estado) VALUES ('Amoxicilina 250mg', 2, 2, 50, 1.20, 2.50, TO_DATE('2026-10-31', 'YYYY-MM-DD'), 'LOTE-A002', 'B-03', 'Activo');
INSERT INTO Medicamentos (nombre, id_categoria, id_proveedor, stock, precio_compra, precio_venta, fecha_vencimiento, lote, ubicacion, estado) VALUES ('Vitamina C 1000mg', 3, 1, 200, 0.80, 1.50, TO_DATE('2027-06-30', 'YYYY-MM-DD'), 'LOTE-V003', 'C-05', 'Activo');
INSERT INTO Medicamentos (nombre, id_categoria, id_proveedor, stock, precio_compra, precio_venta, fecha_vencimiento, lote, ubicacion, estado) VALUES ('Ibuprofeno 400mg', 1, 1, 150, 0.60, 1.20, TO_DATE('2026-08-15', 'YYYY-MM-DD'), 'LOTE-I004', 'A-02', 'Activo');
INSERT INTO Medicamentos (nombre, id_categoria, id_proveedor, stock, precio_compra, precio_venta, fecha_vencimiento, lote, ubicacion, estado) VALUES ('Naproxeno 550mg', 4, 3, 120, 0.90, 1.80, TO_DATE('2026-11-20', 'YYYY-MM-DD'), 'LOTE-N005', 'A-03', 'Activo');
INSERT INTO Medicamentos (nombre, id_categoria, id_proveedor, stock, precio_compra, precio_venta, fecha_vencimiento, lote, ubicacion, estado) VALUES ('Aspirina 100mg', 1, 1, 300, 0.20, 0.50, TO_DATE('2027-01-15', 'YYYY-MM-DD'), 'LOTE-AS06', 'A-04', 'Activo');
INSERT INTO Medicamentos (nombre, id_categoria, id_proveedor, stock, precio_compra, precio_venta, fecha_vencimiento, lote, ubicacion, estado) VALUES ('Loratadina 10mg', 5, 4, 80, 0.40, 1.00, TO_DATE('2026-05-10', 'YYYY-MM-DD'), 'LOTE-L007', 'B-01', 'Activo');
INSERT INTO Medicamentos (nombre, id_categoria, id_proveedor, stock, precio_compra, precio_venta, fecha_vencimiento, lote, ubicacion, estado) VALUES ('Salbutamol Inhalador', 10, 2, 40, 15.00, 28.50, TO_DATE('2025-12-01', 'YYYY-MM-DD'), 'LOTE-S008', 'R-01', 'Activo');
INSERT INTO Medicamentos (nombre, id_categoria, id_proveedor, stock, precio_compra, precio_venta, fecha_vencimiento, lote, ubicacion, estado) VALUES ('Cetirizina 10mg', 5, 4, 90, 0.60, 1.50, TO_DATE('2026-09-22', 'YYYY-MM-DD'), 'LOTE-C009', 'B-02', 'Activo');
INSERT INTO Medicamentos (nombre, id_categoria, id_proveedor, stock, precio_compra, precio_venta, fecha_vencimiento, lote, ubicacion, estado) VALUES ('Omeprazol 20mg', 11, 5, 200, 0.30, 0.80, TO_DATE('2027-03-14', 'YYYY-MM-DD'), 'LOTE-O010', 'G-01', 'Activo');
INSERT INTO Medicamentos (nombre, id_categoria, id_proveedor, stock, precio_compra, precio_venta, fecha_vencimiento, lote, ubicacion, estado) VALUES ('Bismutol Jarabe', 9, 5, 60, 12.00, 22.00, TO_DATE('2026-02-28', 'YYYY-MM-DD'), 'LOTE-B011', 'G-02', 'Activo');
INSERT INTO Medicamentos (nombre, id_categoria, id_proveedor, stock, precio_compra, precio_venta, fecha_vencimiento, lote, ubicacion, estado) VALUES ('Metformina 850mg', 7, 6, 150, 0.50, 1.20, TO_DATE('2026-07-07', 'YYYY-MM-DD'), 'LOTE-M012', 'D-01', 'Activo');
INSERT INTO Medicamentos (nombre, id_categoria, id_proveedor, stock, precio_compra, precio_venta, fecha_vencimiento, lote, ubicacion, estado) VALUES ('Losartan 50mg', 6, 6, 180, 0.70, 1.50, TO_DATE('2027-08-30', 'YYYY-MM-DD'), 'LOTE-LO13', 'H-01', 'Activo');
INSERT INTO Medicamentos (nombre, id_categoria, id_proveedor, stock, precio_compra, precio_venta, fecha_vencimiento, lote, ubicacion, estado) VALUES ('Clotrimazol Crema', 8, 7, 70, 4.00, 9.50, TO_DATE('2026-12-01', 'YYYY-MM-DD'), 'LOTE-CL15', 'DER-01', 'Activo');
INSERT INTO Medicamentos (nombre, id_categoria, id_proveedor, stock, precio_compra, precio_venta, fecha_vencimiento, lote, ubicacion, estado) VALUES ('Dexametasona Amp', 4, 3, 100, 1.50, 3.50, TO_DATE('2026-05-20', 'YYYY-MM-DD'), 'LOTE-D16', 'INY-01', 'Activo');
INSERT INTO Medicamentos (nombre, id_categoria, id_proveedor, stock, precio_compra, precio_venta, fecha_vencimiento, lote, ubicacion, estado) VALUES ('Complejo B', 3, 3, 120, 2.00, 5.00, TO_DATE('2027-01-10', 'YYYY-MM-DD'), 'LOTE-CB17', 'INY-02', 'Activo');
INSERT INTO Medicamentos (nombre, id_categoria, id_proveedor, stock, precio_compra, precio_venta, fecha_vencimiento, lote, ubicacion, estado) VALUES ('Glibenclamida 5mg', 7, 6, 140, 0.10, 0.30, TO_DATE('2026-04-12', 'YYYY-MM-DD'), 'LOTE-G18', 'D-02', 'Activo');
INSERT INTO Medicamentos (nombre, id_categoria, id_proveedor, stock, precio_compra, precio_venta, fecha_vencimiento, lote, ubicacion, estado) VALUES ('Enalapril 20mg', 6, 6, 160, 0.40, 1.00, TO_DATE('2027-09-05', 'YYYY-MM-DD'), 'LOTE-E19', 'H-02', 'Activo');
INSERT INTO Medicamentos (nombre, id_categoria, id_proveedor, stock, precio_compra, precio_venta, fecha_vencimiento, lote, ubicacion, estado) VALUES ('Alcohol 70 1L', 8, 4, 50, 8.00, 15.00, TO_DATE('2028-01-01', 'YYYY-MM-DD'), 'LOTE-AL20', 'VAR-01', 'Activo');
INSERT INTO Medicamentos (nombre, id_categoria, id_proveedor, stock, precio_compra, precio_venta, fecha_vencimiento, lote, ubicacion, estado) VALUES ('Diclofenaco 75mg', 4, 2, 8, 0.80, 1.80, TO_DATE('2025-12-20', 'YYYY-MM-DD'), 'LOTE-DIC201', 'D-05', 'Activo');
INSERT INTO Medicamentos (nombre, id_categoria, id_proveedor, stock, precio_compra, precio_venta, fecha_vencimiento, lote, ubicacion, estado) VALUES ('Ketorolaco 30mg', 1, 5, 3, 2.00, 4.50, TO_DATE('2025-12-15', 'YYYY-MM-DD'), 'LOTE-KET203', 'A-08', 'Activo');
INSERT INTO Medicamentos (nombre, id_categoria, id_proveedor, stock, precio_compra, precio_venta, fecha_vencimiento, lote, ubicacion, estado) VALUES ('Ciprofloxacino 750mg', 2, 1, 7, 1.80, 3.80, TO_DATE('2025-12-22', 'YYYY-MM-DD'), 'LOTE-CIP204', 'B-06', 'Activo');
INSERT INTO Medicamentos (nombre, id_categoria, id_proveedor, stock, precio_compra, precio_venta, fecha_vencimiento, lote, ubicacion, estado) VALUES ('Ranitidina 300mg', 11, 4, 4, 0.90, 2.00, TO_DATE('2025-12-10', 'YYYY-MM-DD'), 'LOTE-RAN205', 'G-05', 'Activo');
INSERT INTO Medicamentos (nombre, id_categoria, id_proveedor, stock, precio_compra, precio_venta, fecha_vencimiento, lote, ubicacion, estado) VALUES ('Prednisona 5mg', 4, 3, 9, 0.30, 0.80, TO_DATE('2025-12-12', 'YYYY-MM-DD'), 'LOTE-PRE207', 'D-06', 'Activo');
INSERT INTO Medicamentos (nombre, id_categoria, id_proveedor, stock, precio_compra, precio_venta, fecha_vencimiento, lote, ubicacion, estado) VALUES ('Levofloxacino 500mg', 2, 5, 2, 2.50, 5.00, TO_DATE('2025-12-08', 'YYYY-MM-DD'), 'LOTE-LEV208', 'B-07', 'Activo');
INSERT INTO Medicamentos (nombre, id_categoria, id_proveedor, stock, precio_compra, precio_venta, fecha_vencimiento, lote, ubicacion, estado) VALUES ('Clorfeniramina 4mg', 5, 1, 8, 0.25, 0.60, TO_DATE('2025-12-17', 'YYYY-MM-DD'), 'LOTE-CLO209', 'B-08', 'Activo');
INSERT INTO Medicamentos (nombre, id_categoria, id_proveedor, stock, precio_compra, precio_venta, fecha_vencimiento, lote, ubicacion, estado) VALUES ('Nimesulida 100mg', 4, 4, 0, 0.95, 2.10, TO_DATE('2025-12-14', 'YYYY-MM-DD'), 'LOTE-NIM210', 'D-07', 'Inactivo');
INSERT INTO Medicamentos (nombre, id_categoria, id_proveedor, stock, precio_compra, precio_venta, fecha_vencimiento, lote, ubicacion, estado) VALUES ('Ambroxol Jarabe 120ml', 10, 2, 0, 5.00, 10.00, TO_DATE('2025-12-19', 'YYYY-MM-DD'), 'LOTE-AMB212', 'J-05', 'Inactivo');
INSERT INTO Medicamentos (nombre, id_categoria, id_proveedor, stock, precio_compra, precio_venta, fecha_vencimiento, lote, ubicacion, estado) VALUES ('Acetaminofén Gotas', 1, 5, 3, 4.00, 8.50, TO_DATE('2025-12-13', 'YYYY-MM-DD'), 'LOTE-ACE215', 'PED-01', 'Activo');
INSERT INTO Medicamentos (nombre, id_categoria, id_proveedor, stock, precio_compra, precio_venta, fecha_vencimiento, lote, ubicacion, estado) VALUES ('Hidrocortisona Crema', 8, 4, 5, 2.80, 6.00, TO_DATE('2025-12-21', 'YYYY-MM-DD'), 'LOTE-HID216', 'DER-03', 'Activo');
INSERT INTO Medicamentos (nombre, id_categoria, id_proveedor, stock, precio_compra, precio_venta, fecha_vencimiento, lote, ubicacion, estado) VALUES ('Bromhexina Jarabe', 10, 3, 4, 3.50, 7.00, TO_DATE('2025-12-07', 'YYYY-MM-DD'), 'LOTE-BRO217', 'J-06', 'Activo');
INSERT INTO Medicamentos (nombre, id_categoria, id_proveedor, stock, precio_compra, precio_venta, fecha_vencimiento, lote, ubicacion, estado) VALUES ('Furosemida 40mg', 6, 6, 7, 0.30, 0.70, TO_DATE('2025-12-06', 'YYYY-MM-DD'), 'LOTE-FUR219', 'H-07', 'Activo');
INSERT INTO Medicamentos (nombre, id_categoria, id_proveedor, stock, precio_compra, precio_venta, fecha_vencimiento, lote, ubicacion, estado) VALUES ('Vitamina B12 Amp', 3, 2, 9, 1.50, 3.50, TO_DATE('2025-12-24', 'YYYY-MM-DD'), 'LOTE-VB220', 'INY-03', 'Activo');
INSERT INTO Medicamentos (nombre, id_categoria, id_proveedor, stock, precio_compra, precio_venta, fecha_vencimiento, lote, ubicacion, estado) VALUES ('Azitromicina 500mg Tab', 2, 3, 0, 2.20, 4.80, TO_DATE('2025-12-05', 'YYYY-MM-DD'), 'LOTE-AZI221', 'B-09', 'Inactivo');

-- Ventas Históricas

INSERT INTO Ventas (dni_cliente, dni_empleado, fecha_venta, total_venta) VALUES ('45678901', '12345678', SYSTIMESTAMP, 3.50);
INSERT INTO Venta_Detalle (id_venta, id_medicamento, cantidad, precio_unitario_venta) VALUES (1, 2, 2, 2.50);
INSERT INTO Venta_Detalle (id_venta, id_medicamento, cantidad, precio_unitario_venta) VALUES (1, 3, 1, 1.50);

INSERT INTO Ventas (dni_cliente, dni_empleado, fecha_venta, total_venta) VALUES ('87654321', '23456789', SYSTIMESTAMP, 19.00);
INSERT INTO Venta_Detalle (id_venta, id_medicamento, cantidad, precio_unitario_venta) VALUES (2, 1, 2, 1.00);
INSERT INTO Venta_Detalle (id_venta, id_medicamento, cantidad, precio_unitario_venta) VALUES (2, 7, 1, 1.00);

INSERT INTO Ventas (dni_cliente, dni_empleado, fecha_venta, total_venta) VALUES ('78901234', '56789012', SYSTIMESTAMP, 24.40);
INSERT INTO Venta_Detalle (id_venta, id_medicamento, cantidad, precio_unitario_venta) VALUES (3, 10, 3, 0.80);
INSERT INTO Venta_Detalle (id_venta, id_medicamento, cantidad, precio_unitario_venta) VALUES (3, 11, 1, 22.00);

INSERT INTO Ventas (dni_cliente, dni_empleado, fecha_venta, total_venta) VALUES ('89012345', '67890123', SYSTIMESTAMP, 15.10);
INSERT INTO Venta_Detalle (id_venta, id_medicamento, cantidad, precio_unitario_venta) VALUES (4, 6, 2, 0.50);
INSERT INTO Venta_Detalle (id_venta, id_medicamento, cantidad, precio_unitario_venta) VALUES (4, 15, 1, 9.50);
INSERT INTO Venta_Detalle (id_venta, id_medicamento, cantidad, precio_unitario_venta) VALUES (4, 5, 2, 1.80);
INSERT INTO Venta_Detalle (id_venta, id_medicamento, cantidad, precio_unitario_venta) VALUES (4, 1, 1, 1.00);

INSERT INTO Ventas (dni_cliente, dni_empleado, fecha_venta, total_venta) VALUES ('90123456', '34567890', SYSTIMESTAMP, 30.00);
INSERT INTO Venta_Detalle (id_venta, id_medicamento, cantidad, precio_unitario_venta) VALUES (5, 8, 1, 28.50);
INSERT INTO Venta_Detalle (id_venta, id_medicamento, cantidad, precio_unitario_venta) VALUES (5, 9, 1, 1.50);

INSERT INTO Ventas (dni_cliente, dni_empleado, fecha_venta, total_venta) VALUES ('01234567', '23456789', SYSTIMESTAMP, 5.00);
INSERT INTO Venta_Detalle (id_venta, id_medicamento, cantidad, precio_unitario_venta) VALUES (6, 17, 1, 5.00);

INSERT INTO Ventas (dni_cliente, dni_empleado, fecha_venta, total_venta) VALUES ('11223344', '12345678', SYSTIMESTAMP, 57.00);
INSERT INTO Venta_Detalle (id_venta, id_medicamento, cantidad, precio_unitario_venta) VALUES (7, 8, 2, 28.50);

INSERT INTO Ventas (dni_cliente, dni_empleado, fecha_venta, total_venta) VALUES ('22334455', '56789012', SYSTIMESTAMP, 4.50);
INSERT INTO Venta_Detalle (id_venta, id_medicamento, cantidad, precio_unitario_venta) VALUES (8, 9, 3, 1.50);

INSERT INTO Ventas (dni_cliente, dni_empleado, fecha_venta, total_venta) VALUES ('33445566', '87654322', SYSTIMESTAMP, 10.00);
INSERT INTO Venta_Detalle (id_venta, id_medicamento, cantidad, precio_unitario_venta) VALUES (9, 13, 2, 1.50);
INSERT INTO Venta_Detalle (id_venta, id_medicamento, cantidad, precio_unitario_venta) VALUES (9, 12, 1, 1.20);
INSERT INTO Venta_Detalle (id_venta, id_medicamento, cantidad, precio_unitario_venta) VALUES (9, 19, 1, 1.00);

INSERT INTO Ventas (dni_cliente, dni_empleado, fecha_venta, total_venta) VALUES ('44556677', '67890123', SYSTIMESTAMP, 100.00);
INSERT INTO Venta_Detalle (id_venta, id_medicamento, cantidad, precio_unitario_venta) VALUES (10, 15, 2, 9.50);
INSERT INTO Venta_Detalle (id_venta, id_medicamento, cantidad, precio_unitario_venta) VALUES (10, 1, 6, 1.00);

INSERT INTO Ventas (dni_cliente, dni_empleado, fecha_venta, total_venta) VALUES ('55667788', '34567890', SYSTIMESTAMP, 12.00);
INSERT INTO Venta_Detalle (id_venta, id_medicamento, cantidad, precio_unitario_venta) VALUES (11, 4, 10, 1.20);

INSERT INTO Ventas (dni_cliente, dni_empleado, fecha_venta, total_venta) VALUES ('66778899', '23456789', SYSTIMESTAMP, 2.40);
INSERT INTO Venta_Detalle (id_venta, id_medicamento, cantidad, precio_unitario_venta) VALUES (12, 18, 8, 0.30);

INSERT INTO Ventas (dni_cliente, dni_empleado, fecha_venta, total_venta) VALUES ('77889900', '12345678', SYSTIMESTAMP, 60.00);
INSERT INTO Venta_Detalle (id_venta, id_medicamento, cantidad, precio_unitario_venta) VALUES (13, 11, 2, 22.00);
INSERT INTO Venta_Detalle (id_venta, id_medicamento, cantidad, precio_unitario_venta) VALUES (13, 2, 2, 2.50);
INSERT INTO Venta_Detalle (id_venta, id_medicamento, cantidad, precio_unitario_venta) VALUES (13, 16, 2, 3.50);

COMMIT;


-- ==========================================================
-- 5. PAQUETE DE GESTIÓN
-- ==========================================================
CREATE OR REPLACE PACKAGE pkg_gestion_farmacia AS
    PROCEDURE p_registrar_medicamento (
        p_nombre IN VARCHAR2, p_id_categoria IN NUMBER, p_id_proveedor IN NUMBER,
        p_stock IN NUMBER, p_precio_compra IN NUMBER, p_precio_venta IN NUMBER,
        p_fecha_vencimiento IN VARCHAR2, p_lote IN VARCHAR2,
        p_ubicacion IN VARCHAR2 DEFAULT NULL, p_descripcion IN VARCHAR2 DEFAULT NULL
    );

    PROCEDURE p_editar_medicamento_completo (
        p_id_medicamento IN NUMBER, p_nombre IN VARCHAR2, p_id_categoria IN NUMBER, p_id_proveedor IN NUMBER,
        p_stock IN NUMBER, p_precio_compra IN NUMBER, p_precio_venta IN NUMBER,
        p_fecha_vencimiento IN VARCHAR2, p_lote IN VARCHAR2, p_ubicacion IN VARCHAR2 DEFAULT NULL, p_descripcion IN VARCHAR2 DEFAULT NULL
    );

    PROCEDURE p_editar_precio (p_id_medicamento IN NUMBER, p_nuevo_precio_compra IN NUMBER, p_nuevo_precio_venta IN NUMBER);
    PROCEDURE p_actualizar_stock (p_id_medicamento IN NUMBER, p_cantidad_agregada IN NUMBER);
    
    PROCEDURE p_eliminar_medicamento (p_id_medicamento IN NUMBER);
    PROCEDURE p_cambiar_estado_medicamento (p_id_medicamento IN NUMBER, p_nuevo_estado IN VARCHAR2);

    PROCEDURE p_registrar_venta_con_cliente (
        p_dni_cliente IN VARCHAR2, p_nombre_cli IN VARCHAR2, p_ape_pat_cli IN VARCHAR2, p_ape_mat_cli IN VARCHAR2,
        p_dni_empleado IN VARCHAR2, p_total_venta IN NUMBER, p_id_venta_generada OUT NUMBER
    );
END pkg_gestion_farmacia;
/

CREATE OR REPLACE PACKAGE BODY pkg_gestion_farmacia AS
    PROCEDURE p_registrar_medicamento (
        p_nombre IN VARCHAR2, p_id_categoria IN NUMBER, p_id_proveedor IN NUMBER,
        p_stock IN NUMBER, p_precio_compra IN NUMBER, p_precio_venta IN NUMBER,
        p_fecha_vencimiento IN VARCHAR2, p_lote IN VARCHAR2, p_ubicacion IN VARCHAR2, p_descripcion IN VARCHAR2
    ) AS BEGIN
        INSERT INTO Medicamentos (nombre, id_categoria, id_proveedor, stock, precio_compra, precio_venta, fecha_vencimiento, lote, ubicacion, descripcion)
        VALUES (p_nombre, p_id_categoria, p_id_proveedor, p_stock, p_precio_compra, p_precio_venta, TO_DATE(p_fecha_vencimiento,'YYYY-MM-DD'), p_lote, p_ubicacion, p_descripcion);
        COMMIT;
    END;

    PROCEDURE p_editar_medicamento_completo (
        p_id_medicamento IN NUMBER, p_nombre IN VARCHAR2, p_id_categoria IN NUMBER, p_id_proveedor IN NUMBER,
        p_stock IN NUMBER, p_precio_compra IN NUMBER, p_precio_venta IN NUMBER,
        p_fecha_vencimiento IN VARCHAR2, p_lote IN VARCHAR2, p_ubicacion IN VARCHAR2, p_descripcion IN VARCHAR2
    ) AS BEGIN
        UPDATE Medicamentos SET nombre = p_nombre, id_categoria = p_id_categoria, id_proveedor = p_id_proveedor,
            stock = p_stock, precio_compra = p_precio_compra, precio_venta = p_precio_venta,
            fecha_vencimiento = TO_DATE(p_fecha_vencimiento, 'YYYY-MM-DD'), lote = p_lote, ubicacion = p_ubicacion, descripcion = p_descripcion
        WHERE id_medicamento = p_id_medicamento;
        COMMIT;
    END;

    PROCEDURE p_editar_precio (p_id_medicamento IN NUMBER, p_nuevo_precio_compra IN NUMBER, p_nuevo_precio_venta IN NUMBER) AS BEGIN
        UPDATE Medicamentos SET precio_compra = p_nuevo_precio_compra, precio_venta = p_nuevo_precio_venta WHERE id_medicamento = p_id_medicamento;
        COMMIT;
    END;

    PROCEDURE p_actualizar_stock (p_id_medicamento IN NUMBER, p_cantidad_agregada IN NUMBER) AS BEGIN
        UPDATE Medicamentos SET stock = stock + p_cantidad_agregada, estado = CASE WHEN estado='Agotado' THEN 'Activo' ELSE estado END WHERE id_medicamento = p_id_medicamento;
        COMMIT;
    END;

    PROCEDURE p_eliminar_medicamento (p_id_medicamento IN NUMBER) AS BEGIN
        UPDATE Medicamentos SET estado = 'Inactivo' WHERE id_medicamento = p_id_medicamento;
        COMMIT;
    END;
    
    PROCEDURE p_cambiar_estado_medicamento (p_id_medicamento IN NUMBER, p_nuevo_estado IN VARCHAR2) AS 
        v_stock NUMBER;
    BEGIN
        -- Si se quiere reactivar, verificamos el stock para saber si queda en Activo o Agotado
        IF p_nuevo_estado = 'Activo' THEN
            SELECT stock INTO v_stock FROM Medicamentos WHERE id_medicamento = p_id_medicamento;
            IF v_stock <= 0 THEN
                UPDATE Medicamentos SET estado = 'Agotado' WHERE id_medicamento = p_id_medicamento;
            ELSE
                UPDATE Medicamentos SET estado = 'Activo' WHERE id_medicamento = p_id_medicamento;
            END IF;
        ELSE
            -- Si es Inactivo u otro, se aplica directo
            UPDATE Medicamentos SET estado = p_nuevo_estado WHERE id_medicamento = p_id_medicamento;
        END IF;
        COMMIT;
    END;
    

    PROCEDURE p_registrar_venta_con_cliente (
        p_dni_cliente IN VARCHAR2, p_nombre_cli IN VARCHAR2, p_ape_pat_cli IN VARCHAR2, p_ape_mat_cli IN VARCHAR2,
        p_dni_empleado IN VARCHAR2, p_total_venta IN NUMBER, p_id_venta_generada OUT NUMBER
    ) AS BEGIN
        MERGE INTO Usuarios u USING (SELECT p_dni_cliente AS dni FROM dual) s ON (u.dni = s.dni)
        WHEN MATCHED THEN UPDATE SET nombre = p_nombre_cli, apellido_paterno = p_ape_pat_cli, apellido_materno = p_ape_mat_cli
        WHEN NOT MATCHED THEN INSERT (dni, nombre, apellido_paterno, apellido_materno) VALUES (p_dni_cliente, p_nombre_cli, p_ape_pat_cli, p_ape_mat_cli);

        INSERT INTO Clientes (dni) SELECT p_dni_cliente FROM DUAL WHERE NOT EXISTS (SELECT 1 FROM Clientes WHERE dni = p_dni_cliente);
        INSERT INTO Ventas (dni_cliente, dni_empleado, total_venta) VALUES (p_dni_cliente, p_dni_empleado, p_total_venta) RETURNING id_venta INTO p_id_venta_generada;
    END;
END pkg_gestion_farmacia;
/

-- ==========================================================
-- 6. PAQUETE REPORTES
-- ==========================================================
CREATE OR REPLACE PACKAGE pkg_reportes_farmacia AS
    TYPE T_CURSOR IS REF CURSOR;

    -- 1. Inventario General
    PROCEDURE p_reporte_medicamentos_por_categoria (p_cursor OUT T_CURSOR);
    
    -- 2. Rentabilidad
    PROCEDURE p_reporte_rentabilidad_productos (p_cursor OUT T_CURSOR);
    
    -- 3. Bajo Stock
    PROCEDURE p_reporte_medicamentos_bajo_stock_detalle (p_cursor OUT T_CURSOR);
    
    -- 4. Inactivos
    PROCEDURE p_reporte_medicamentos_inactivos (p_cursor OUT T_CURSOR);
    
    -- 5. Vencimientos
    PROCEDURE p_reporte_medicamentos_proximos_vencer (p_dias IN NUMBER, p_cursor OUT T_CURSOR);
    
    -- 6. Stock Crítico
    PROCEDURE p_reporte_medicamentos_sin_stock (p_cursor OUT T_CURSOR);
    
    -- 7. Ventas por Empleado
    PROCEDURE p_reporte_ventas_por_empleado (p_cursor OUT T_CURSOR);
    
    -- 8. Ventas por Cliente
    PROCEDURE p_reporte_ventas_por_cliente (p_cursor OUT T_CURSOR);
    
    -- 9. Top Vendidos
    PROCEDURE p_reporte_top_5_vendidos (p_cursor OUT T_CURSOR);
    
    -- 10. Ingresos Mensuales
    PROCEDURE p_reporte_ingresos_por_mes (p_cursor OUT T_CURSOR);

END pkg_reportes_farmacia;
/

CREATE OR REPLACE PACKAGE BODY pkg_reportes_farmacia AS

    -- 1. INVENTARIO GENERAL
    PROCEDURE p_reporte_medicamentos_por_categoria (p_cursor OUT T_CURSOR) AS BEGIN
        OPEN p_cursor FOR 
            SELECT c.nombre as categoria, m.nombre as medicamento, p.nombre as proveedor, m.stock, m.precio_venta 
            FROM Medicamentos m 
            JOIN Categorias c ON m.id_categoria = c.id_categoria 
            LEFT JOIN Proveedores p ON m.id_proveedor = p.id_proveedor
            WHERE m.estado = 'Activo' ORDER BY c.nombre, m.nombre;
    END;

    -- 2. RENTABILIDAD (NUEVO) - ENHANCED
    PROCEDURE p_reporte_rentabilidad_productos (p_cursor OUT T_CURSOR) AS BEGIN
        OPEN p_cursor FOR 
            SELECT m.nombre, c.nombre as categoria, p.nombre as proveedor, m.stock, m.precio_compra, m.precio_venta, 
                   (m.precio_venta - m.precio_compra) AS ganancia_unitaria,
                   ROUND(((m.precio_venta - m.precio_compra) / NULLIF(m.precio_venta,0)) * 100, 1) AS margen_porcentaje
            FROM Medicamentos m
            JOIN Categorias c ON m.id_categoria = c.id_categoria
            LEFT JOIN Proveedores p ON m.id_proveedor = p.id_proveedor
            WHERE m.estado = 'Activo' ORDER BY ganancia_unitaria DESC;
    END;

    -- 3. BAJO STOCK DETALLADO (REEMPLAZA AUDITORÍA) - ENHANCED
    PROCEDURE p_reporte_medicamentos_bajo_stock_detalle (p_cursor OUT T_CURSOR) AS BEGIN
        OPEN p_cursor FOR 
            SELECT m.nombre, c.nombre as categoria, p.nombre as proveedor, m.stock, m.precio_compra, m.precio_venta, m.ubicacion, m.lote, m.fecha_vencimiento
            FROM Medicamentos m
            JOIN Categorias c ON m.id_categoria = c.id_categoria
            LEFT JOIN Proveedores p ON m.id_proveedor = p.id_proveedor
            WHERE m.stock <= 10 AND m.estado = 'Activo'
            ORDER BY m.stock ASC;
    END;

    -- 4. INACTIVOS (NUEVO) - ENHANCED
    PROCEDURE p_reporte_medicamentos_inactivos (p_cursor OUT T_CURSOR) AS BEGIN
        OPEN p_cursor FOR 
            SELECT m.nombre, c.nombre as categoria, p.nombre as proveedor, m.lote, m.ubicacion, m.stock, m.precio_compra, m.fecha_vencimiento
            FROM Medicamentos m
            JOIN Categorias c ON m.id_categoria = c.id_categoria
            LEFT JOIN Proveedores p ON m.id_proveedor = p.id_proveedor
            WHERE m.estado = 'Inactivo' ORDER BY m.nombre;
    END;

    -- 5. VENCIMIENTOS (Próximos días)
    PROCEDURE p_reporte_medicamentos_proximos_vencer (p_dias IN NUMBER, p_cursor OUT T_CURSOR) AS BEGIN 
        OPEN p_cursor FOR 
            SELECT nombre, lote, fecha_vencimiento, (fecha_vencimiento - TRUNC(SYSDATE)) as dias_restantes
            FROM Medicamentos 
            WHERE fecha_vencimiento BETWEEN TRUNC(SYSDATE) AND (TRUNC(SYSDATE) + p_dias) AND estado = 'Activo'
            ORDER BY fecha_vencimiento ASC; 
    END;

    -- 6. SIN STOCK
    PROCEDURE p_reporte_medicamentos_sin_stock (p_cursor OUT T_CURSOR) AS BEGIN 
        OPEN p_cursor FOR 
            SELECT m.nombre, m.lote, m.estado, p.nombre as proveedor
            FROM Medicamentos m
            LEFT JOIN Proveedores p ON m.id_proveedor = p.id_proveedor
            WHERE m.stock <= 0 OR m.estado = 'Agotado'; 
    END;

    -- 7. VENTAS POR EMPLEADO
    PROCEDURE p_reporte_ventas_por_empleado (p_cursor OUT T_CURSOR) AS BEGIN
        OPEN p_cursor FOR 
            SELECT u.nombre || ' ' || u.apellido_paterno as empleado, COUNT(v.id_venta) as total_ventas, SUM(v.total_venta) as total_dinero
            FROM Ventas v JOIN Empleados e ON v.dni_empleado = e.dni JOIN Usuarios u ON e.dni = u.dni 
            GROUP BY u.nombre, u.apellido_paterno ORDER BY total_dinero DESC;
    END;

    -- 8. VENTAS POR CLIENTE
    PROCEDURE p_reporte_ventas_por_cliente (p_cursor OUT T_CURSOR) AS BEGIN
        OPEN p_cursor FOR 
            SELECT u.nombre || ' ' || u.apellido_paterno as cliente, COUNT(v.id_venta) as compras, SUM(v.total_venta) as gastado
            FROM Ventas v JOIN Clientes c ON v.dni_cliente = c.dni JOIN Usuarios u ON c.dni = u.dni 
            GROUP BY u.nombre, u.apellido_paterno ORDER BY gastado DESC;
    END;

    -- 9. TOP 5 VENDIDOS
    PROCEDURE p_reporte_top_5_vendidos (p_cursor OUT T_CURSOR) AS BEGIN 
        OPEN p_cursor FOR 
            SELECT m.nombre, c.nombre as categoria, SUM(d.cantidad) as total_unidades
            FROM Venta_Detalle d 
            JOIN Medicamentos m ON d.id_medicamento = m.id_medicamento 
            JOIN Categorias c ON m.id_categoria = c.id_categoria
            GROUP BY m.nombre, c.nombre ORDER BY total_unidades DESC FETCH FIRST 5 ROWS ONLY; 
    END;

    -- 10. INGRESOS MENSUALES
    PROCEDURE p_reporte_ingresos_por_mes (p_cursor OUT T_CURSOR) AS BEGIN 
        OPEN p_cursor FOR 
            SELECT TO_CHAR(fecha_venta, 'YYYY-MM') as mes, COUNT(id_venta) as num_ventas, SUM(total_venta) as total_ingresos
            FROM Ventas GROUP BY TO_CHAR(fecha_venta, 'YYYY-MM') ORDER BY mes DESC; 
    END;

END pkg_reportes_farmacia;
/


-- ==========================================================
-- 1. REPORTE: LISTA DE MEDICAMENTOS POR CATEGORÍA
-- ==========================================================
DECLARE
    CURSOR c_meds IS
        SELECT c.nombre AS categoria, m.nombre AS medicamento, p.nombre as proveedor, m.stock, m.precio_venta
        FROM Medicamentos m
        JOIN Categorias c ON m.id_categoria = c.id_categoria
        LEFT JOIN Proveedores p ON m.id_proveedor = p.id_proveedor
        WHERE m.estado = 'Activo'
        ORDER BY c.nombre, m.nombre;
BEGIN
    DBMS_OUTPUT.PUT_LINE('=== 1. INVENTARIO POR CATEGORIA ===');
    FOR r IN c_meds LOOP
        DBMS_OUTPUT.PUT_LINE('[' || r.categoria || '] ' || r.medicamento || 
                             ' | Prov: ' || NVL(r.proveedor, 'N/A') ||
                             ' | Stock: ' || r.stock || 
                             ' | Precio: S/.' || r.precio_venta);
    END LOOP;
END;
/

-- ==========================================================
-- 2. REPORTE: RENTABILIDAD POR PRODUCTO
-- ==========================================================
DECLARE
    CURSOR c_rentabilidad IS
        SELECT m.nombre, c.nombre as categoria, p.nombre as proveedor, m.stock, m.precio_compra, m.precio_venta, 
               (m.precio_venta - m.precio_compra) AS ganancia_unitaria,
               ROUND(((m.precio_venta - m.precio_compra) / NULLIF(m.precio_venta,0)) * 100, 1) AS margen_pct
        FROM Medicamentos m
        JOIN Categorias c ON m.id_categoria = c.id_categoria
        LEFT JOIN Proveedores p ON m.id_proveedor = p.id_proveedor
        WHERE m.estado = 'Activo'
        ORDER BY ganancia_unitaria DESC;
BEGIN
    DBMS_OUTPUT.PUT_LINE('=== 2. ANALISIS DE RENTABILIDAD (Ganancia por unidad) ===');
    FOR r IN c_rentabilidad LOOP
        DBMS_OUTPUT.PUT_LINE(r.nombre || 
                             ' | Cat: ' || r.categoria ||
                             ' | Prov: ' || NVL(r.proveedor, 'N/A') ||
                             ' | Compra: S/.' || r.precio_compra || 
                             ' | Venta: S/.' || r.precio_venta ||
                             ' | GANA: S/.' || r.ganancia_unitaria || ' (' || r.margen_pct || '%)');
    END LOOP;
END;
/

-- ==========================================================
-- 3. REPORTE: MEDICAMENTOS CON BAJO STOCK (DETALLADO)
-- ==========================================================
DECLARE
    CURSOR c_bajo_stock IS
        SELECT m.nombre, c.nombre as categoria, p.nombre as proveedor, m.stock, m.precio_venta, m.ubicacion
        FROM Medicamentos m
        JOIN Categorias c ON m.id_categoria = c.id_categoria
        LEFT JOIN Proveedores p ON m.id_proveedor = p.id_proveedor
        WHERE m.stock <= 10 AND m.estado = 'Activo'
        ORDER BY m.stock ASC;
BEGIN
    DBMS_OUTPUT.PUT_LINE('=== 3. ALERTA DE BAJO STOCK (Menos de 10 unidades) ===');
    FOR r IN c_bajo_stock LOOP
        DBMS_OUTPUT.PUT_LINE(r.nombre || ' | Cat: ' || r.categoria || 
                             ' | Prov: ' || NVL(r.proveedor, 'N/A') || 
                             ' | Quedan: ' || r.stock ||
                             ' | Ubic: ' || NVL(r.ubicacion, 'N/A'));
    END LOOP;
END;
/

-- ==========================================================
-- 4. REPORTE: MEDICAMENTOS INACTIVOS
-- ==========================================================
DECLARE
    CURSOR c_inactivos IS
        SELECT m.nombre, c.nombre as categoria, m.lote, m.ubicacion, m.stock
        FROM Medicamentos m
        JOIN Categorias c ON m.id_categoria = c.id_categoria
        WHERE m.estado = 'Inactivo'
        ORDER BY m.nombre;
BEGIN
    DBMS_OUTPUT.PUT_LINE('=== 4. MEDICAMENTOS INACTIVOS (Para retirar de estantería) ===');
    FOR r IN c_inactivos LOOP
        DBMS_OUTPUT.PUT_LINE('Medicamento: ' || r.nombre || 
                             ' | Cat: ' || r.categoria ||
                             ' | Ubicación: ' || NVL(r.ubicacion, 'Sin Asignar') || 
                             ' | Stock remanente: ' || r.stock);
    END LOOP;
END;
/

-- ==========================================================
-- 5. REPORTE: MEDICAMENTOS PRÓXIMOS A VENCER
-- ==========================================================
DECLARE
    CURSOR c_vencer IS
        SELECT nombre, fecha_vencimiento, lote, (fecha_vencimiento - TRUNC(SYSDATE)) as dias
        FROM Medicamentos
        WHERE fecha_vencimiento BETWEEN SYSDATE AND SYSDATE + 60 -- Ampliado a 60 días
          AND estado = 'Activo'
        ORDER BY fecha_vencimiento;
BEGIN
    DBMS_OUTPUT.PUT_LINE('=== 5. ALERTA DE VENCIMIENTO (Próximos 60 días) ===');
    FOR r IN c_vencer LOOP
        DBMS_OUTPUT.PUT_LINE('ALERTA: ' || r.nombre || 
                             ' | Lote: ' || r.lote || 
                             ' | Vence en: ' || r.dias || ' días (' || TO_CHAR(r.fecha_vencimiento, 'DD/MM/YYYY') || ')');
    END LOOP;
END;
/

-- ==========================================================
-- 6. REPORTE: MEDICAMENTOS SIN STOCK
-- ==========================================================
DECLARE
    CURSOR c_sin_stock IS
        SELECT nombre, id_proveedor
        FROM Medicamentos
        WHERE stock <= 0 OR estado = 'Agotado';
BEGIN
    DBMS_OUTPUT.PUT_LINE('=== 6. MEDICAMENTOS AGOTADOS (Reponer) ===');
    FOR r IN c_sin_stock LOOP
        DBMS_OUTPUT.PUT_LINE('Falta: ' || r.nombre || ' (Contactar Proveedor ID: ' || r.id_proveedor || ')');
    END LOOP;
END;
/

-- ==========================================================
-- 7. REPORTE: VENTAS POR EMPLEADO (Rendimiento)
-- ==========================================================
DECLARE
    CURSOR c_ventas_emp IS
        SELECT u.nombre || ' ' || u.apellido_paterno AS empleado,
               COUNT(v.id_venta) AS total_ventas,
               SUM(v.total_venta) AS total_monto
        FROM Ventas v
        JOIN Empleados e ON v.dni_empleado = e.dni
        JOIN Usuarios u ON e.dni = u.dni
        GROUP BY u.nombre, u.apellido_paterno
        ORDER BY total_monto DESC;
BEGIN
    DBMS_OUTPUT.PUT_LINE('=== 7. RANKING DE VENDEDORES ===');
    FOR r IN c_ventas_emp LOOP
        DBMS_OUTPUT.PUT_LINE(r.empleado || 
                             ' | N° Ventas: ' || r.total_ventas || 
                             ' | Recaudado: S/.' || NVL(r.total_monto, 0));
    END LOOP;
END;
/

-- ==========================================================
-- 8. REPORTE: VENTAS POR CLIENTE (Fidelización)
-- ==========================================================
DECLARE
    CURSOR c_ventas_cli IS
        SELECT u.nombre || ' ' || u.apellido_paterno AS cliente,
               COUNT(v.id_venta) AS total_compras,
               SUM(v.total_venta) AS gastado
        FROM Ventas v
        JOIN Clientes c ON v.dni_cliente = c.dni
        JOIN Usuarios u ON c.dni = u.dni
        GROUP BY u.nombre, u.apellido_paterno
        ORDER BY gastado DESC
        FETCH FIRST 10 ROWS ONLY;
BEGIN
    DBMS_OUTPUT.PUT_LINE('=== 8. TOP MEJORES CLIENTES ===');
    FOR r IN c_ventas_cli LOOP
        DBMS_OUTPUT.PUT_LINE(r.cliente || 
                             ' | Compras: ' || r.total_compras || 
                             ' | Gasto Total: S/.' || NVL(r.gastado, 0));
    END LOOP;
END;
/

-- ==========================================================
-- 9. REPORTE: TOP 5 MEDICAMENTOS MÁS VENDIDOS
-- ==========================================================
DECLARE
    CURSOR c_top IS
        SELECT m.nombre, c.nombre as categoria, SUM(d.cantidad) AS total_vendido
        FROM Venta_Detalle d
        JOIN Medicamentos m ON d.id_medicamento = m.id_medicamento
        JOIN Categorias c ON m.id_categoria = c.id_categoria
        GROUP BY m.nombre, c.nombre
        ORDER BY total_vendido DESC
        FETCH FIRST 5 ROWS ONLY;
BEGIN
    DBMS_OUTPUT.PUT_LINE('=== 9. TOP 5 PRODUCTOS ESTRELLA ===');
    FOR r IN c_top LOOP
        DBMS_OUTPUT.PUT_LINE('#' || c_top%ROWCOUNT || ' ' || r.nombre || 
                             ' (' || r.categoria || ')' ||
                             ' | Unidades vendidas: ' || r.total_vendido);
    END LOOP;
END;
/

-- ==========================================================
-- 10. REPORTE: INGRESOS POR MES (Finanzas)
-- ==========================================================
DECLARE
    CURSOR c_ingresos IS
        SELECT TO_CHAR(fecha_venta, 'YYYY-MM') AS mes,
               COUNT(id_venta) AS num_ventas,
               SUM(total_venta) AS total_mes
        FROM Ventas
        GROUP BY TO_CHAR(fecha_venta, 'YYYY-MM')
        ORDER BY mes DESC;
BEGIN
    DBMS_OUTPUT.PUT_LINE('=== 10. HISTORIAL DE INGRESOS MENSUALES ===');
    FOR r IN c_ingresos LOOP
        DBMS_OUTPUT.PUT_LINE('Mes: ' || r.mes || 
                             ' | Transacciones: ' || r.num_ventas || 
                             ' | Total Caja: S/.' || NVL(r.total_mes, 0));
    END LOOP;
END;
/
